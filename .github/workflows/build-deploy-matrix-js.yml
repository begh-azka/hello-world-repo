# Common job for build and deploy
name: Build-Deploy-Matrix-Js
permissions:
  contents: write

on:
  workflow_call:
    secrets:
        MONGO_PASSWORD: 
          description: "Database secret"
          required: true
    inputs:
      MONGO_USERNAME: 
        type: string
        description: "Database secret"
        required: true
        
      build_type:
        required: true
        type: string

      dev:
        required: false
        type: string

      sit:
        required: false
        type: string

      qa:
        required: false
        type: string

      prod:
        required: false
        type: string

      dry_run:
        required: true
        type: boolean

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    env:
       # MONGO_URI: 'mongodb+srv://supercluster.d83jj.mongodb.net/superData'
        MONGO_USERNAME: ${{ vars.MONGO_USERNAME }}
        MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}

    steps:
      - name: Checkout Source Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Install Dependencies 
        run: npm ci

      - name: Run Unit Testing
        run: npm test
      
      - name: Archive Test Results
        uses: actions/upload-artifact@v4
        with:
          name: npm-test-results-${{ github.run_number }}
          path: test-results.xml
  
      - name: Run Code Coverage
        run: npm run coverage
        continue-on-error: true

      - name: Archive Coverage Results
        uses: actions/upload-artifact@v4
        with:
          name: npm-coverage-results-${{ github.run_number }}
          path: coverage
      
      - name: Create Tag and Push It
        if: ${{ contains(github.ref_name = 'main','release/') }} && ( ${{ inputs.build_type == 'Release'}} )
        run: |
           echo ${{ inputs.environment}}
           TAG="v1.0.${{ github.run_number }}"
           echo "Tag: $TAG"
           git tag $TAG
           git push origin $TAG

  Deployment:
    name: Deploy to ${{ matrix.env }}
    needs: build
    runs-on: ubuntu-latest
    
    strategy:
      max-parallel: 1
      matrix: 
        env: [ "${{ inputs.dev }}", "${{ inputs.qa }}", "${{ inputs.sit }}", "${{ (inputs.prod }}" ]

    if: >
        matrix.env != '' &&
        (
        github.ref == 'refs/heads/main' ||
        startsWith(github.ref, 'refs/heads/release/') ||
        startsWith(github.ref, 'refs/tags/')
    
    environment: ${{ matrix.env }}
    steps:
      - run: |
          echo "Hello world from {{ matrix.env }}
          echo -------------------------------------------
